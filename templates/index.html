<!DOCTYPE html>
<html>
<head>
    <title>Outbound Traffic Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        .card { display: inline-block; padding: 20px; border: 1px solid #ccc; border-radius: 10px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; }
        p { font-size: 20px; }
        .warn { color: orange; }
        .over { color: red; }
        .offset-container { display: inline-flex; align-items: center; gap: 8px; }
        .pen-icon { cursor: pointer; font-size: 16px; color: #666; user-select: none; }
        .pen-icon:hover { color: #333; }
        .offset-input { 
            width: 80px; 
            padding: 4px 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Outbound Traffic Monitor</h1>
        <p><strong>Month:</strong> <span id="month-value">{{ month }}</span></p>
        <p><strong>Used:</strong> <span id="used-value">{{ used_gb }} GB / {{ cap_gb }} GB</span></p>
        <p>
            <strong>Manual Offset:</strong> 
            <div class="offset-container">
                <span id="offset-display">{{ offset_gb }} GB</span>
                <span class="pen-icon" onclick="editOffset()">✏️</span>
                <input type="number" class="offset-input hidden" id="offset-input" 
                       value="{{ offset_gb }}" step="0.01" min="0" 
                       onkeypress="handleEnter(event)" onblur="cancelEdit()">
            </div>
        </p>
        <p id="status-message" class="{{ status_class }}">{{ status_msg }}</p>
        <p><small>Last Update: <span id="last-update">{{ last_update }}</span></small></p>
    </div>
    
    <script>
        let isEditing = false;
        
        function editOffset() {
            if (isEditing) return;
            isEditing = true;
            
            const display = document.getElementById('offset-display');
            const input = document.getElementById('offset-input');
            
            display.classList.add('hidden');
            input.classList.remove('hidden');
            input.focus();
            input.select();
        }
        
        function cancelEdit() {
            if (!isEditing) return;
            isEditing = false;
            
            const display = document.getElementById('offset-display');
            const input = document.getElementById('offset-input');
            
            display.classList.remove('hidden');
            input.classList.add('hidden');
        }
        
        function handleEnter(event) {
            if (event.key === 'Enter') {
                submitOffset();
            }
        }
        
        function submitOffset() {
            const input = document.getElementById('offset-input');
            const newOffset = parseFloat(input.value) || 0;
            
            fetch('/adjust', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({offset: newOffset})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update display immediately
                    document.getElementById('offset-display').textContent = newOffset.toFixed(2) + ' GB';
                    cancelEdit();
                    // Refresh data after successful update
                    updateData();
                } else {
                    alert('Error: ' + data.error);
                    cancelEdit();
                }
            })
            .catch(error => {
                alert('Error updating offset: ' + error);
                cancelEdit();
            });
        }
        
        function updateData() {
            if (isEditing) return; // Don't update while editing
            
            fetch('/data')
            .then(response => response.json())
            .then(data => {
                // Update all dynamic fields
                document.getElementById('month-value').textContent = data.month;
                document.getElementById('used-value').textContent = data.used_gb + ' GB / ' + data.cap_gb + ' GB';
                document.getElementById('offset-display').textContent = data.offset_gb + ' GB';
                document.getElementById('offset-input').value = data.offset_gb;
                
                // Update status
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = data.status_msg;
                statusElement.className = data.status_class;
                
                // Update last update time
                document.getElementById('last-update').textContent = data.last_update;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        }
        
        // Update data every 5 seconds instead of reloading page
        setInterval(updateData, 5000);
        
        // Initial data load
        updateData();
    </script>
</body>
</html>
